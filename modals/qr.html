<div class="qrg">
  <canvas id="qr-preview" width="800px" height="600px" style="margin-bottom: 1em;"></canvas>
  <div id="preview-chooser">
    <div class="variant" data-num="1">1</div>
    <div class="variant" data-num="2">2</div>
    <div class="variant" data-num="3">3</div>
    <div class="variant" data-num="4">4</div>
  </div>
  <div id="bgColors">
    <div data-i18n-title="other.bg">Фон</div>
    <div id="colorsList"></div>
  </div>
  <div id="dataContainer">
    <div class="inputContainer">
      <input class="text-input" id="qr-link" type="text" data-i18n-title="buttons.link" placeholder="Ссылка">
      <input class="checkbox" id="linkVisibility" data-type="link" type="checkbox" checked="true">
      <label for="linkVisibility">
        <div class="checkbox button icon" data-i18n-title="buttons.visibility" title="Видимость">
          <svg style="enable-background:new 0 0 512 512; fill: currentColor" version="1.1" viewBox="0 0 512 512" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256,36C143.903,36,55.019,144.529,18.291,197.539C6.389,214.716,0,235.102,0,256v0c0,20.898,6.389,41.284,18.291,58.461   C55.019,367.471,143.903,476,256,476s200.981-108.529,237.709-161.539C505.611,297.284,512,276.898,512,256v0   c0-20.898-6.389-41.284-18.291-58.461C456.981,144.529,368.097,36,256,36z M256,396c-77.196,0-140-62.804-140-140   s62.804-140,140-140s140,62.804,140,140S333.196,396,256,396z"/><circle cx="256" cy="256" r="80"/></svg>
        </div>
      </label>
      <input type="color" class="color" data-type="qr" data-subtype="bg">
      <input type="color" class="color" data-type="qr" data-subtype="fg">
    </div>
    <div class="inputContainer">
      <input class="text-input" id="qr-title" type="text" data-i18n-title="buttons.title" placeholder="Заголовок">
      <input class="checkbox" id="titleVisibility" data-type="title" type="checkbox" checked="true">
      <label for="titleVisibility">
        <div class="checkbox button icon" data-i18n-title="buttons.visibility" title="Видимость">
          <svg style="enable-background:new 0 0 512 512; fill: currentColor"" version="1.1" viewBox="0 0 512 512" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256,36C143.903,36,55.019,144.529,18.291,197.539C6.389,214.716,0,235.102,0,256v0c0,20.898,6.389,41.284,18.291,58.461   C55.019,367.471,143.903,476,256,476s200.981-108.529,237.709-161.539C505.611,297.284,512,276.898,512,256v0   c0-20.898-6.389-41.284-18.291-58.461C456.981,144.529,368.097,36,256,36z M256,396c-77.196,0-140-62.804-140-140   s62.804-140,140-140s140,62.804,140,140S333.196,396,256,396z"/><circle cx="256" cy="256" r="80"/></svg>
        </div>
      </label>
      <input id="titleColor" type="color" class="color" data-type="title">
    </div>
    <div class="inputContainer">
      <input class="text-input" id="qr-subtitle" type="text" data-i18n-title="buttons.subtitle" placeholder="Подзаголовок">
      <input class="checkbox" id="subtitleVisibility" data-type="subtitle" type="checkbox" checked="true">
      <label for="subtitleVisibility">
        <div class="checkbox button icon" data-i18n-title="buttons.visibility">
          <svg style="enable-background:new 0 0 512 512; fill: currentColor"" version="1.1" viewBox="0 0 512 512" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256,36C143.903,36,55.019,144.529,18.291,197.539C6.389,214.716,0,235.102,0,256v0c0,20.898,6.389,41.284,18.291,58.461   C55.019,367.471,143.903,476,256,476s200.981-108.529,237.709-161.539C505.611,297.284,512,276.898,512,256v0   c0-20.898-6.389-41.284-18.291-58.461C456.981,144.529,368.097,36,256,36z M256,396c-77.196,0-140-62.804-140-140   s62.804-140,140-140s140,62.804,140,140S333.196,396,256,396z"/><circle cx="256" cy="256" r="80"/></svg>
        </div>
      </label>
      <input type="color" class="color" data-type="subtitle">
    </div>
  </div>
  <div class="inputContainer" style="margin-top: 1em">
    <input class="text-input" id="qr-filename" type="text" data-i18n-title="buttons.download" placeholder="">
    <div id="save" class="button icon" onclick="javascript:qrCanvas.save()" class="checkbox button"
      title="Скачать">
      <svg version="1.1" viewBox="0 0 24 24" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path fill="currentColor"
          d="M11.2,16.6c0.4,0.5,1.2,0.5,1.6,0l6-6.3C19.3,9.8,18.8,9,18,9h-4c0,0,0.2-4.6,0-7c-0.1-1.1-0.9-2-2-2c-1.1,0-1.9,0.9-2,2 c-0.2,2.3,0,7,0,7H6c-0.8,0-1.3,0.8-0.8,1.4L11.2,16.6z" />
        <path fill="currentColor"
          d="M19,19H5c-1.1,0-2,0.9-2,2v0c0,0.6,0.4,1,1,1h16c0.6,0,1-0.4,1-1v0C21,19.9,20.1,19,19,19z" />
      </svg>
    </div>
  </div>
</div>
<script>
  document.getElementById('preview-chooser').querySelectorAll('.variant').forEach(v => {
    v.addEventListener('click', () => qrCanvas.changeType(v.getAttribute('data-num')))
  })
  document.getElementById('dataContainer').querySelectorAll('[type="checkbox"]').forEach(v => {
    v.addEventListener('click', e => {
      qrCanvas.v[e.target.getAttribute('data-type')] = e.target.checked
      qrCanvas.clear()
      qrCanvas.update()
    })
  })
  document.getElementById('qr-filename').setAttribute('placeholder', `${document.getElementById('fileName').value ? document.getElementById('fileName').value : document.getElementById('fileName').getAttribute('data-default')}` + `_qr`)

  const pc = {
    1: {
      bg: {
        type: 'gradient',
        colors: [{
            c: '#3e3e3e'
          },
          {
            c: '#000000'
          }
        ]
      },
      preview: {
        x: 48,
        y: 12,
        size: .8
      },
      qr: {
        x: 480,
        y: 160,
        size: 200,
        c: {
          bg: '#ffffff',
          fg: '#000000'
        }
      },
      title: {
        x: 480,
        y: 450,
        w: '250',
        s: '40px Arial',
        c: '#ffffff'
      },
      subtitle: {
        x: 480,
        y: 500,
        w: '250',
        s: '30px Arial',
        c: '#ffffff'
      }
    },
    2: {
      bg: {
        type: 'steps',
        colors: [
          {
            c: '#ffffff',
            x: 0,
            y: 0
          },
          {
            c: '#000000',
            x: 0,
            y: 450
          }
        ]
      },
      preview: {
        x: 400,
        y: 12,
        size: .8
      },
      qr: {
        x: 80,
        y: 100,
        size: 280,
        c: {
          bg: '#ffffff',
          fg: '#000000'
        }
      },
      title: {
        x: 50,
        y: 510,
        w: 450,
        c: '#ffffff',
        s: '40px Arial'
      },
      subtitle: {
        x: 50,
        y: 550,
        w: 450,
        c: '#dddddd',
        s: '30px Arial'
      }
    },
    3: {
      bg: {
        type: 'steps',
        colors: [
          {
            c: '#000000',
            x: 0,
            y: 0
          }
        ]
      },
      preview: {
        x: -100,
        y: 30,
        size: 1
      },
      qr: {
        x: 400,
        y: 250,
        size: 200,
        c: {
          bg: '#ffffff',
          fg: '#000000'
        }
      },
      title: {
        x: 400,
        y: 550,
        w: '200',
        s: '40px Arial',
        c: '#ffffff'
      },
      subtitle: {
        x: 400,
        y: 600,
        w: '200',
        s: '30px Arial',
        c: '#ffffff'
      }
    },
    4: {
      bg: {
        type: 'steps',
        colors: [
          {
            c: '#000000',
            x: 0,
            y: 0
          },
          {
            c: '#ffffff',
            x: 290,
            y: 0
          }
        ]
      },
      preview: {
        x: 50,
        y: -100,
        size: 1
      },
      qr: {
        x: 540,
        y: 150,
        size: 200,
        c: {
          bg: '#ffffff',
          fg: '#000000'
        }
      },
      title: {
        x: 550,
        y: 450,
        w: '200',
        s: '40px Arial',
        c: '#000000'
      },
      subtitle: {
        x: 550,
        y: 500,
        w: '200',
        s: '30px Arial',
        c: '#000000'
      }
    }
  }

  class Canvas {
    constructor() {
      this.canvas = document.getElementById('qr-preview')
      this.ctx = this.canvas.getContext('2d')
      this.wf = document.getElementById('canvas')
      this.wfctx = this.wf.getContext('2d')
      this.qrCode = {}
      this.width = 800
      this.height = 600
      this.type = 1 // default 1, see 'pc' object
      this.params = pc[this.type]
      this.v = {
        link: true,
        title: true,
        subtitle: true
      }
    }

    init() {
      this.canvas.width = this.width
      this.canvas.height = this.height
      this.updateData()
      this.updateColors()
    }

    clear() {
      this.ctx.restore()
      this.ctx.clearRect(0, 0, this.width, this.height)
    }

    update() {
      this.clear()
      if (this.params.bg.type == 'gradient') {
        const gradient = this.ctx.createRadialGradient(this.width / 2, this.height / 2, this.height / 4, this.width / 2, this.height / 2, this.width)
        let colorsLength = this.params.bg.colors.length
        this.params.bg.colors.forEach((c, i) => {
          gradient.addColorStop(1 / colorsLength * i, c.c)
        })
        this.ctx.fillStyle = gradient
        this.ctx.fillRect(0, 0, this.width, this.height)
      } else {
        this.params.bg.colors.forEach((c, index) => {
          this.ctx.fillStyle = c.c
          this.ctx.fillRect(c.x, c.y, this.width, this.height)
        })
      }

      if (this.type == 3) {
        this.ctx.save()
        this.ctx.rotate(-Math.PI / 12)
      }
      this.ctx.drawImage(this.wf, this.params.preview.x, this.params.preview.y, this.wf.width * this.params.preview.size, this.wf.height * this.params.preview.size)

      if (this.v.link) {
        this.qr = document.createElement('canvas')
        this.qrCode = new QRCode(this.qr, {
          text: this.link,
          width: 256,
          height: 256,
          colorDark: this.params.qr.c.fg,
          colorLight: this.params.qr.c.bg,
          correctLevel: QRCode.CorrectLevel.H
        })
        this.ctx.fillStyle = this.params.qr.c.bg
        this.ctx.fillRect(this.params.qr.x, this.params.qr.y, this.params.qr.size, this.params.qr.size)
        setTimeout(() => this.ctx.drawImage(this.qrCode._el.querySelector('img'), this.params.qr.x + 10, this.params.qr.y + 10, this.params.qr.size - 20, this.params.qr.size - 20), 50)
      }

      if (this.v.title) {
        this.ctx.fillStyle = this.params.title.c
        this.ctx.font = this.params.title.s
        this.ctx.fillText(this.title, this.params.title.x, this.params.title.y, this.params.title.w)
      }
      if (this.v.subtitle) {
        this.ctx.fillStyle = this.params.subtitle.c
        this.ctx.font = this.params.subtitle.s
        this.ctx.fillText(this.subtitle, this.params.subtitle.x, this.params.subtitle.y, this.params.subtitle.w)
      }
    }

    changeType(t) {
      this.type = t
      this.params = pc[this.type]
      this.update()
      this.updateColors()
    }

    updateData() {
      this.link = document.getElementById('qr-link').value == '' ? 'https://example.com' : document.getElementById('qr-link').value
      this.title = document.getElementById('qr-title').value == '' ? document.getElementById('qr-title').getAttribute('placeholder') : document.getElementById('qr-title').value
      this.subtitle = document.getElementById('qr-subtitle').value == '' ? document.getElementById('qr-subtitle').getAttribute('placeholder') : document.getElementById('qr-subtitle').value
      this.update()
    }

    updateColors() {
      const colorsList = document.getElementById("colorsList")
      colorsList.innerHTML = ""
      this.params.bg.colors.forEach((c, index) => {
        let colorElem = document.createElement('input')
        colorElem.classList.add('color')
        colorElem.type = "color"
        colorElem.value = c.c
        colorElem.addEventListener('input', e => {
          c.c = e.target.value
          this.update()
        })
        colorsList.appendChild(colorElem)
      })
    }

    save() {
      const link = document.createElement('a')
      const input = document.getElementById('qr-filename')
      link.download = `${input.value ? input.value : input.getAttribute('placeholder')}.png`
      link.href = this.canvas.toDataURL('image/png')
      link.click()
    }
  }

  const qrCanvas = new Canvas()
  qrCanvas.init()

  document.getElementById('dataContainer').querySelectorAll('input').forEach(e => {
    let type = e.getAttribute('data-type')
    let subtype = e.getAttribute('data-subtype')
    if (e.getAttribute('type') == 'color') e.value = subtype ? qrCanvas.params[type].c[subtype] : qrCanvas.params[type].c
    e.addEventListener('input', () => {
      if (e.getAttribute('type') == 'color') {
        e.getAttribute('data-subtype') ? qrCanvas.params[type].c[subtype] = e.value : qrCanvas.params[type].c = e.value
        qrCanvas.update()
      }
      qrCanvas.updateData()
    })
  })
</script>